<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Solvix.Client.MVVM.ViewModels"
             xmlns:models="clr-namespace:Solvix.Client.Core.Models"
             xmlns:local="clr-namespace:Solvix.Client"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="Solvix.Client.MVVM.Views.ChatPage"
             x:DataType="viewmodels:ChatViewModel"
             Shell.NavBarIsVisible="False"
             BackgroundColor="{DynamicResource PageBackgroundColor}">

    <ContentPage.Resources>
        <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />
        <local:MessageStatusIconConverter x:Key="MessageStatusIconConverter" />
        <local:MessageStatusOpacityConverter x:Key="MessageStatusOpacityConverter" />
        <local:IsOwnMessageToAlignmentConverter x:Key="IsOwnMessageToAlignmentConverter" />
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- هدر -->
        <Border Grid.Row="0" 
              BackgroundColor="{DynamicResource PrimaryColor}" 
              HeightRequest="65"
              StrokeThickness="0"
              Padding="10,5">
            <Border.Shadow>
                <Shadow Brush="{DynamicResource ShadowColor}"
                        Offset="0,4"
                        Opacity="0.2"
                        Radius="5" />
            </Border.Shadow>

            <Grid ColumnDefinitions="Auto,*,Auto" VerticalOptions="Center">
                <!-- دکمه بازگشت -->
                <Button Grid.Column="0"
                        Text="←"
                        Command="{Binding BackCommand}"
                        FontSize="24"
                        TextColor="White"
                        BackgroundColor="Transparent"
                        Margin="5,0,0,0"
                        WidthRequest="40">
                </Button>

                <!-- اطلاعات کاربر -->
                <HorizontalStackLayout Grid.Column="1" 
                                       Spacing="12" 
                                       HorizontalOptions="Start" 
                                       VerticalOptions="Center">
                    <!-- تصویر پروفایل/آواتار -->
                    <Border BackgroundColor="White" 
                            StrokeThickness="0"
                            StrokeShape="RoundRectangle 22,22,22,22"
                            HeightRequest="44" 
                            WidthRequest="44"
                            VerticalOptions="Center">
                        <Label Text="{Binding Chat.OtherParticipant.Initials, TargetNullValue='?'}" 
                               TextColor="{DynamicResource PrimaryColor}" 
                               FontAttributes="Bold"
                               FontSize="18"
                               HorizontalOptions="Center" 
                               VerticalOptions="Center" />
                    </Border>

                    <!-- اطلاعات کاربر -->
                    <VerticalStackLayout Spacing="0" VerticalOptions="Center">
                        <Label Text="{Binding Chat.DisplayTitle, TargetNullValue='چت'}" 
                               TextColor="White" 
                               FontAttributes="Bold" 
                               FontSize="16" />

                        <HorizontalStackLayout Spacing="5">
                            <!-- نشانگر آنلاین - فقط اگر کاربر آنلاین باشد نشان داده می‌شود -->
                            <Ellipse IsVisible="{Binding Chat.OtherParticipant.IsOnline}"
             Fill="{DynamicResource OnlineStatusColor}"
             HeightRequest="8"
             WidthRequest="8"
             VerticalOptions="Center"
             Margin="0,0,2,0">
                                <Ellipse.Shadow>
                                    <Shadow Brush="{DynamicResource OnlineStatusColor}"
                    Offset="0,0"
                    Opacity="0.5"
                    Radius="3" />
                                </Ellipse.Shadow>
                            </Ellipse>

                            <!-- وضعیت آنلاین یا آخرین بازدید -->
                            <Label Text="{Binding Chat.LastActivityStatus}" 
           TextColor="White" 
           Opacity="0.9" 
           FontSize="12"
           VerticalOptions="Center" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </HorizontalStackLayout>

                <!-- دکمه پروفایل -->
                <Button Grid.Column="2"
                        Text="⋮"
                        Command="{Binding ViewProfileCommand}"
                        FontSize="24"
                        TextColor="White"
                        BackgroundColor="Transparent"
                        WidthRequest="40">
                </Button>
            </Grid>
        </Border>

        <!-- پیام‌ها -->
        <CollectionView Grid.Row="1" 
                       ItemsSource="{Binding Messages}"
                       Margin="0,10,0,0"
                       ItemsUpdatingScrollMode="KeepLastItemInView"
                       SelectionMode="None"
                       RemainingItemsThreshold="20"
                       RemainingItemsThresholdReachedCommand="{Binding LoadMoreMessagesCommand}">

            <CollectionView.EmptyView>
                <Grid IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}">
                    <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center">
                        <Image Source="empty_chat.png" HeightRequest="150" WidthRequest="150" Opacity="0.7" 
                               IsVisible="False"/>

                        <Label Text="هنوز پیامی وجود ندارد" 
                               FontSize="18" 
                               TextColor="{DynamicResource SecondaryTextColor}" 
                               HorizontalOptions="Center" 
                               Margin="0,20,0,0" />

                        <Label Text="با ارسال یک پیام، مکالمه را شروع کنید" 
                               FontSize="14" 
                               TextColor="{DynamicResource TertiaryTextColor}" 
                               HorizontalOptions="Center" 
                               MaxLines="2" 
                               LineBreakMode="WordWrap" 
                               Margin="20,5,20,0" />
                    </VerticalStackLayout>
                </Grid>
            </CollectionView.EmptyView>

            <CollectionView.ItemTemplate>
                <!-- بخش پیام‌ها در ChatPage.xaml -->
                <DataTemplate x:DataType="models:MessageModel">
                    <Grid Padding="10,5">
                        <Border BackgroundColor="{Binding IsOwnMessage, Converter={StaticResource IsOwnMessageToAlignmentConverter}, ConverterParameter='BgColor'}"
                StrokeThickness="0"
                StrokeShape="RoundRectangle 18,18,18,2"
                Padding="15,10"
                HorizontalOptions="{Binding IsOwnMessage, Converter={StaticResource IsOwnMessageToAlignmentConverter}}"
                MaximumWidthRequest="300">
                            <Grid RowDefinitions="*,Auto">
                                <!-- Contenido del mensaje -->
                                <Label Grid.Row="0" 
                       Text="{Binding Content}" 
                       TextColor="{Binding IsOwnMessage, Converter={StaticResource IsOwnMessageToAlignmentConverter}, ConverterParameter='TextColor'}" 
                       FontSize="16"
                       LineBreakMode="WordWrap"
                       Margin="0,0,0,5" />

                                <!-- Tiempo y estado -->
                                <Grid Grid.Row="1" ColumnDefinitions="Auto,*,Auto">
                                    <!-- Ícono de estado (solo para mensajes propios) -->
                                    <Label Grid.Column="0"
                           IsVisible="{Binding IsOwnMessage}"
                           Text="{Binding Status, Converter={StaticResource MessageStatusIconConverter}}"
                           TextColor="{Binding IsFailed, Converter={StaticResource BoolToColorConverter}, ConverterParameter='Error', FallbackValue={StaticResource SecondaryTextColor}}"
                           Opacity="{Binding Status, Converter={StaticResource MessageStatusOpacityConverter}}"
                           VerticalOptions="Center"
                           FontSize="14"
                           Margin="0,0,5,0" />

                                    <!-- Espaciador -->
                                    <BoxView Grid.Column="1" BackgroundColor="Transparent" />

                                    <!-- Tiempo del mensaje -->
                                    <Label Grid.Column="2" 
                           Text="{Binding SentAtFormatted}" 
                           TextColor="{Binding IsOwnMessage, Converter={StaticResource IsOwnMessageToAlignmentConverter}, ConverterParameter='TextColor'}" 
                           FontSize="12"
                           VerticalOptions="Center"
                           Opacity="0.8" />
                                </Grid>
                            </Grid>
                        </Border>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- ورودی پیام -->
        <Border Grid.Row="2" 
                BackgroundColor="{DynamicResource CardBackgroundColor}"
                StrokeThickness="0"
                Padding="10,15">
            <Border.Shadow>
                <Shadow Brush="{DynamicResource ShadowColor}"
                        Offset="0,-4"
                        Opacity="0.1"
                        Radius="8" />
            </Border.Shadow>

            <Grid ColumnDefinitions="*,Auto">
                <Border Grid.Column="0"
                        Stroke="{DynamicResource PrimaryColor}"
                        StrokeThickness="1.5"
                        StrokeShape="RoundRectangle 25,25,25,25"
                        BackgroundColor="{DynamicResource PageBackgroundColor}"
                        Padding="5,0">
                    <Entry Text="{Binding MessageText}"
                           Placeholder="پیام خود را بنویسید..."
                           PlaceholderColor="{DynamicResource TertiaryTextColor}"
                           TextColor="{DynamicResource PrimaryTextColor}"
                           BackgroundColor="Transparent"
                           VerticalOptions="Center"
                           Margin="15,0,0,0" />
                </Border>

                <Button Grid.Column="1"
                        Text="ارسال"
                        Command="{Binding SendMessageCommand}"
                        IsEnabled="{Binding CanSendMessage}"
                        BackgroundColor="{DynamicResource PrimaryColor}"
                        TextColor="White"
                        FontAttributes="Bold"
                        CornerRadius="25"
                        Margin="8,0,0,0"
                        HeightRequest="50"
                        WidthRequest="90">
                </Button>
            </Grid>
        </Border>

        <!-- نشانگر بارگذاری -->
        <Border Grid.Row="1"
                IsVisible="{Binding IsLoading}"
                HorizontalOptions="Center"
                VerticalOptions="Center"
                StrokeThickness="0"
                StrokeShape="RoundRectangle 12,12,12,12"
                BackgroundColor="{DynamicResource CardBackgroundColor}"
                Padding="20">
            <Border.Shadow>
                <Shadow Brush="{DynamicResource ShadowColor}"
                        Offset="0,3"
                        Opacity="0.2"
                        Radius="10" />
            </Border.Shadow>
            <VerticalStackLayout Spacing="10">
                <ActivityIndicator IsRunning="{Binding IsLoading}" 
                                   Color="{DynamicResource PrimaryColor}" 
                                   HeightRequest="40" 
                                   WidthRequest="40" />
                <Label Text="در حال بارگذاری پیام‌ها..." 
                       TextColor="{DynamicResource PrimaryTextColor}" 
                       FontSize="14" 
                       HorizontalOptions="Center" />
            </VerticalStackLayout>
        </Border>
    </Grid>
</ContentPage>