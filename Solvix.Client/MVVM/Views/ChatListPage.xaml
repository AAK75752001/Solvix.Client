<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:Solvix.Client.MVVM.ViewModels"
             xmlns:model="clr-namespace:Solvix.Client.Core.Models"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:converters="clr-namespace:Solvix.Client.Core.Converters"
             x:Class="Solvix.Client.MVVM.Views.ChatListPage"
             x:DataType="vm:ChatListViewModel"
             BackgroundColor="{DynamicResource PageBackgroundColor}"
             Title="پیام‌های سالویکس">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:DateTimeToFormattedStringConverter x:Key="DateTimeFormatter" />
            <toolkit:IntToBoolConverter x:Key="IntToBoolConverter"/>
            <converters:BoolToColorConverter x:Key="OnlineStatusColorConverter" TrueColor="{StaticResource OnlineStatusColor}" FalseColor="{StaticResource OfflineStatusColor}" />
            <toolkit:InvertedBoolConverter x:Key="InverseBoolConverter" />

            <!-- استایل آیتم چت -->
            <Style x:Key="ChatItemBorderStyle" TargetType="Border">
                <Setter Property="Padding" Value="14, 14"/>
                <Setter Property="StrokeShape">
                    <RoundRectangle CornerRadius="16"/>
                </Setter>
                <Setter Property="StrokeThickness" Value="0"/>
                <Setter Property="BackgroundColor" Value="{DynamicResource CardBackgroundColor}"/>
                <Setter Property="Margin" Value="12,6"/>
                <Setter Property="Shadow">
                    <Shadow Brush="{DynamicResource ShadowColor}" Offset="0,2" Radius="6" Opacity="0.08"/>
                </Setter>
                <Setter Property="VisualStateManager.VisualStateGroups">
                    <VisualStateGroupList>
                        <VisualStateGroup x:Name="CommonStates">
                            <VisualState x:Name="Normal" />
                            <VisualState x:Name="PointerOver">
                                <VisualState.Setters>
                                    <Setter Property="BackgroundColor" Value="{DynamicResource InputFieldFocusBorderColor}" />
                                    <Setter Property="Shadow">
                                        <Shadow Brush="{DynamicResource ShadowColor}" Offset="0,3" Radius="8" Opacity="0.12"/>
                                    </Setter>
                                </VisualState.Setters>
                            </VisualState>
                            <VisualState x:Name="Pressed">
                                <VisualState.Setters>
                                    <Setter Property="BackgroundColor" Value="{DynamicResource InputFieldFocusBorderColor}" />
                                    <Setter Property="Scale" Value="0.98" />
                                </VisualState.Setters>
                            </VisualState>
                        </VisualStateGroup>
                    </VisualStateGroupList>
                </Setter>
            </Style>

            <!-- استایل دایره نمایش حرف اول نام -->
            <Style x:Key="InitialsCircleStyle" TargetType="Border">
                <Setter Property="HeightRequest" Value="58"/>
                <Setter Property="WidthRequest" Value="58"/>
                <Setter Property="StrokeShape">
                    <RoundRectangle CornerRadius="29"/>
                </Setter>
                <Setter Property="BackgroundColor" Value="{DynamicResource PrimaryColor}"/>
                <Setter Property="VerticalOptions" Value="Center"/>
                <Setter Property="HorizontalOptions" Value="Center"/>
            </Style>

            <!-- استایل متن حرف اول نام -->
            <Style x:Key="InitialsLabelStyle" TargetType="Label">
                <Setter Property="FontSize" Value="22"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="TextColor" Value="{DynamicResource InverseTextColor}"/>
                <Setter Property="HorizontalOptions" Value="Center"/>
                <Setter Property="VerticalOptions" Value="Center"/>
                <Setter Property="HorizontalTextAlignment" Value="Center"/>
                <Setter Property="VerticalTextAlignment" Value="Center"/>
                <Setter Property="FontFamily" Value="Vazirmatn"/>
            </Style>

            <!-- استایل نشانگر وضعیت آنلاین -->
            <Style x:Key="OnlineStatusIndicatorStyle" TargetType="Border">
                <Setter Property="WidthRequest" Value="16"/>
                <Setter Property="HeightRequest" Value="16"/>
                <Setter Property="StrokeShape">
                    <RoundRectangle CornerRadius="8"/>
                </Setter>
                <Setter Property="HorizontalOptions" Value="End"/>
                <Setter Property="VerticalOptions" Value="End"/>
                <Setter Property="Margin" Value="0,0,0,2"/>
                <Setter Property="Stroke" Value="{DynamicResource PageBackgroundColor}"/>
                <Setter Property="StrokeThickness" Value="2.5"/>
            </Style>

            <!-- استایل عنوان چت -->
            <Style x:Key="ChatTitleStyle" TargetType="Label">
                <Setter Property="FontSize" Value="16"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="TextColor" Value="{DynamicResource PrimaryTextColor}"/>
                <Setter Property="LineBreakMode" Value="TailTruncation"/>
                <Setter Property="VerticalOptions" Value="Center"/>
                <Setter Property="HorizontalOptions" Value="Start"/>
                <Setter Property="HorizontalTextAlignment" Value="Start"/>
                <Setter Property="FontFamily" Value="Vazirmatn"/>
            </Style>

            <!-- استایل آخرین پیام -->
            <Style x:Key="LastMessageStyle" TargetType="Label">
                <Setter Property="FontSize" Value="14"/>
                <Setter Property="TextColor" Value="{DynamicResource SecondaryTextColor}"/>
                <Setter Property="LineBreakMode" Value="TailTruncation"/>
                <Setter Property="VerticalOptions" Value="Center"/>
                <Setter Property="HorizontalOptions" Value="Start"/>
                <Setter Property="HorizontalTextAlignment" Value="Start"/>
                <Setter Property="MaxLines" Value="1"/>
                <Setter Property="FontFamily" Value="Vazirmatn"/>
            </Style>

            <!-- استایل زمان آخرین پیام -->
            <Style x:Key="TimestampStyle" TargetType="Label">
                <Setter Property="FontSize" Value="12"/>
                <Setter Property="TextColor" Value="{DynamicResource TertiaryTextColor}"/>
                <Setter Property="HorizontalOptions" Value="End"/>
                <Setter Property="VerticalOptions" Value="Start"/>
                <Setter Property="FontFamily" Value="Vazirmatn"/>
            </Style>

            <!-- استایل نشانگر پیام‌های خوانده نشده -->
            <Style x:Key="UnreadBadgeStyle" TargetType="Border">
                <Setter Property="BackgroundColor" Value="{DynamicResource PrimaryColor}"/>
                <Setter Property="StrokeShape">
                    <RoundRectangle CornerRadius="12"/>
                </Setter>
                <Setter Property="Padding" Value="8,2"/>
                <Setter Property="HorizontalOptions" Value="End"/>
                <Setter Property="VerticalOptions" Value="End"/>
                <Setter Property="MinimumWidthRequest" Value="24"/>
                <Setter Property="MinimumHeightRequest" Value="24"/>
                <Setter Property="Margin" Value="0,6,0,0"/>
            </Style>

            <!-- استایل عدد پیام‌های خوانده نشده -->
            <Style x:Key="UnreadCountLabelStyle" TargetType="Label">
                <Setter Property="TextColor" Value="{DynamicResource InverseTextColor}"/>
                <Setter Property="FontSize" Value="12"/>
                <Setter Property="HorizontalTextAlignment" Value="Center"/>
                <Setter Property="VerticalTextAlignment" Value="Center"/>
                <Setter Property="FontAttributes" Value="Bold"/>
                <Setter Property="FontFamily" Value="Vazirmatn"/>
            </Style>

            <!-- استایل جستجو -->
            <Style x:Key="SearchBarStyle" TargetType="SearchBar">
                <Setter Property="BackgroundColor" Value="{DynamicResource CardBackgroundColor}"/>
                <Setter Property="TextColor" Value="{DynamicResource PrimaryTextColor}"/>
                <Setter Property="PlaceholderColor" Value="{DynamicResource TertiaryTextColor}"/>
                <Setter Property="CancelButtonColor" Value="{DynamicResource PrimaryColor}"/>
                <Setter Property="FontFamily" Value="Vazirmatn"/>
                <Setter Property="FontSize" Value="15"/>
                <Setter Property="Margin" Value="12,8"/>
                <Setter Property="Placeholder" Value="جستجو در پیام‌ها..."/>
            </Style>

            <!-- استایل دکمه شناور چت جدید -->
            <Style x:Key="NewChatButtonStyle" TargetType="ImageButton">
                <Setter Property="BackgroundColor" Value="{DynamicResource PrimaryColor}"/>
                <Setter Property="CornerRadius" Value="30"/>
                <Setter Property="HeightRequest" Value="60"/>
                <Setter Property="WidthRequest" Value="60"/>
                <Setter Property="Padding" Value="14"/>
                <Setter Property="HorizontalOptions" Value="End"/>
                <Setter Property="VerticalOptions" Value="End"/>
                <Setter Property="Margin" Value="0,0,16,16"/>
                <Setter Property="Shadow">
                    <Shadow Brush="{DynamicResource ShadowColor}" Offset="0,4" Radius="10" Opacity="0.2"/>
                </Setter>
                <Setter Property="VisualStateManager.VisualStateGroups">
                    <VisualStateGroupList>
                        <VisualStateGroup x:Name="CommonStates">
                            <VisualState x:Name="Normal" />
                            <VisualState x:Name="Pressed">
                                <VisualState.Setters>
                                    <Setter Property="BackgroundColor" Value="{DynamicResource ButtonHighlightColor}" />
                                    <Setter Property="Scale" Value="0.95" />
                                </VisualState.Setters>
                            </VisualState>
                        </VisualStateGroup>
                    </VisualStateGroupList>
                </Setter>
            </Style>

            <!-- استایل متن خالی -->
            <Style x:Key="EmptyViewTextStyle" TargetType="Label">
                <Setter Property="TextColor" Value="{DynamicResource TertiaryTextColor}"/>
                <Setter Property="FontSize" Value="16"/>
                <Setter Property="HorizontalTextAlignment" Value="Center"/>
                <Setter Property="HorizontalOptions" Value="Center"/>
                <Setter Property="Margin" Value="20"/>
                <Setter Property="FontFamily" Value="Vazirmatn"/>
            </Style>

            <Style x:Key="EmptyViewButtonStyle" TargetType="Button">
                <Setter Property="BackgroundColor" Value="{DynamicResource PrimaryColor}"/>
                <Setter Property="TextColor" Value="{DynamicResource InverseTextColor}"/>
                <Setter Property="FontSize" Value="14"/>
                <Setter Property="CornerRadius" Value="20"/>
                <Setter Property="Padding" Value="16,10"/>
                <Setter Property="HorizontalOptions" Value="Center"/>
                <Setter Property="Margin" Value="0,16,0,0"/>
                <Setter Property="FontFamily" Value="Vazirmatn"/>
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ContentPage.ToolbarItems>
        <ToolbarItem IconImageSource="{FontImageSource FontFamily=MaterialIcons, Glyph=search, Color={DynamicResource PrimaryTextColor}}"
                     Command="{Binding SearchCommand}"
                     Order="Primary" Priority="0"/>
        <ToolbarItem IconImageSource="{FontImageSource FontFamily=MaterialIcons, Glyph=settings, Color={DynamicResource PrimaryTextColor}}"
                     Command="{Binding GoToSettingsCommand}"
                     Order="Primary" Priority="1"/>
    </ContentPage.ToolbarItems>

    <Grid RowDefinitions="Auto, *" BackgroundColor="{DynamicResource PageBackgroundColor}">

        <!-- جستجو -->
        <SearchBar Grid.Row="0" 
                   Style="{StaticResource SearchBarStyle}"
                   Text="{Binding SearchQuery, Mode=TwoWay}"
                   SearchCommand="{Binding SearchTriggeredCommand}"/>

        <!-- لیست چت‌ها -->
        <RefreshView Grid.Row="1"
                     Command="{Binding RefreshCommand}"
                     IsRefreshing="{Binding IsRefreshing}"
                     RefreshColor="{DynamicResource PrimaryColor}">
            <CollectionView ItemsSource="{Binding FilteredChats}"
                            SelectionMode="None">
                <CollectionView.EmptyView>
                    <StackLayout VerticalOptions="Center" HorizontalOptions="Center" Margin="20">
                        <Image Source="empty_chat.png" HeightRequest="120" IsVisible="False"/>
                        <Label Text="هنوز گفتگویی ندارید!" 
                               Style="{StaticResource EmptyViewTextStyle}" 
                               FontAttributes="Bold" 
                               FontSize="18"/>
                        <Label Text="با دوستان خود گفتگو را شروع کنید." 
                               Style="{StaticResource EmptyViewTextStyle}"/>
                        <Button Text="شروع گفتگوی جدید" 
                                Command="{Binding NewChatCommand}" 
                                Style="{StaticResource EmptyViewButtonStyle}"/>
                    </StackLayout>
                </CollectionView.EmptyView>
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="model:ChatModel">
                        <Border Style="{StaticResource ChatItemBorderStyle}">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:ChatListViewModel}}, Path=GoToChatCommand}"
                                                       CommandParameter="{Binding .}"/>
                            </Border.GestureRecognizers>
                            <Grid ColumnDefinitions="Auto, *, Auto" RowDefinitions="Auto, Auto" ColumnSpacing="14" RowSpacing="4">

                                <!-- آواتار و نشانگر وضعیت -->
                                <Grid Grid.Row="0" Grid.Column="0" Grid.RowSpan="2" VerticalOptions="Center">
                                    <Border Style="{StaticResource InitialsCircleStyle}">
                                        <Label Text="{Binding OtherParticipant.Initials}" Style="{StaticResource InitialsLabelStyle}"/>
                                    </Border>
                                    <Border Style="{StaticResource OnlineStatusIndicatorStyle}"
                                           BackgroundColor="{Binding OtherParticipant.IsOnline, Converter={StaticResource OnlineStatusColorConverter}}"
                                           IsVisible="{Binding IsGroup, Converter={toolkit:InvertedBoolConverter}}"/>
                                </Grid>

                                <!-- عنوان و آخرین پیام -->
                                <Label Grid.Row="0" Grid.Column="1" Text="{Binding DisplayTitle}" Style="{StaticResource ChatTitleStyle}" />
                                <Label Grid.Row="1" Grid.Column="1" Text="{Binding LastMessage}" Style="{StaticResource LastMessageStyle}"/>

                                <!-- زمان و تعداد پیام خوانده نشده -->
                                <Label Grid.Row="0" Grid.Column="2" Text="{Binding LastMessageTime, Converter={StaticResource DateTimeFormatter}}" Style="{StaticResource TimestampStyle}" />
                                <Border Grid.Row="1" Grid.Column="2" Style="{StaticResource UnreadBadgeStyle}"
                                      IsVisible="{Binding UnreadCount, Converter={StaticResource IntToBoolConverter}}">
                                    <Label Text="{Binding UnreadCount}" Style="{StaticResource UnreadCountLabelStyle}"/>
                                </Border>

                            </Grid>
                        </Border>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
            </CollectionView>
        </RefreshView>

        <!-- دکمه چت جدید -->
        <ImageButton Grid.Row="1"
                     Source="{FontImageSource FontFamily=MaterialIcons, Glyph=chat, Color={DynamicResource InverseTextColor}}"
                     Style="{StaticResource NewChatButtonStyle}"
                     Command="{Binding NewChatCommand}"/>

        <!-- نشانگر لودینگ -->
        <ActivityIndicator Grid.Row="0" Grid.RowSpan="2"
                           IsRunning="{Binding IsLoading}" 
                           IsVisible="{Binding IsLoading}"
                           HorizontalOptions="Center" 
                           VerticalOptions="Center"
                           Color="{DynamicResource PrimaryColor}"/>
    </Grid>
</ContentPage>