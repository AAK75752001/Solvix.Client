<?xml version="1.0" encoding="utf-8" ?>
<ContentView xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Solvix.Client.MVVM.ViewModels"
             xmlns:models="clr-namespace:Solvix.Client.Core.Models"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             x:Class="Solvix.Client.MVVM.Views.ChatListPage"
             x:DataType="viewmodels:ChatListViewModel">

    <Grid RowDefinitions="Auto,*">
        <!-- Search Bar -->
        <Border Grid.Row="0" 
                Margin="15,10" 
                Padding="5"
                StrokeThickness="1"
                StrokeShape="RoundRectangle 25,25,25,25"
                Stroke="{DynamicResource PrimaryColor}"
                BackgroundColor="{DynamicResource CardBackgroundColor}">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <Label Grid.Column="0" 
                       Text="ðŸ”" 
                       FontSize="18" 
                       VerticalOptions="Center" 
                       Margin="10,0,0,0" />

                <Entry Grid.Column="1" 
                       Text="{Binding SearchQuery}" 
                       Placeholder="Search chats"
                       PlaceholderColor="{DynamicResource TertiaryTextColor}"
                       TextColor="{DynamicResource PrimaryTextColor}"
                       BackgroundColor="Transparent"
                       ReturnCommand="{Binding SearchCommand}" />

                <Button Grid.Column="2" 
                        Text="âœ•" 
                        Command="{Binding ClearSearchCommand}"
                        IsVisible="{Binding SearchQuery, Converter={StaticResource StringToBoolConverter}}"
                        BackgroundColor="Transparent"
                        TextColor="{DynamicResource PrimaryTextColor}"
                        FontSize="18"
                        WidthRequest="40" />
            </Grid>
        </Border>

        <!-- Chat List -->
        <RefreshView Grid.Row="1" 
                     IsRefreshing="{Binding IsRefreshing}" 
                     Command="{Binding RefreshCommand}">
            <Grid>
                <CollectionView ItemsSource="{Binding FilteredChats}"
                   SelectionMode="Single"
                   SelectionChangedCommand="{Binding ChatSelectedCommand}"
                   SelectionChangedCommandParameter="{Binding Source={RelativeSource Self}, Path=SelectedItem}">

                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="5" />
                    </CollectionView.ItemsLayout>

                    <CollectionView.EmptyView>
                        <Grid IsVisible="{Binding IsEmpty}">
                            <VerticalStackLayout VerticalOptions="Center" HorizontalOptions="Center">
                                <Image Source="empty_chat.png" HeightRequest="150" WidthRequest="150" Opacity="0.7" />

                                <Label Text="No chats yet" 
                                       FontSize="18" 
                                       TextColor="{DynamicResource SecondaryTextColor}" 
                                       HorizontalOptions="Center" 
                                       Margin="0,20,0,0" />

                                <Label Text="Start a new conversation by tapping the + button" 
                                       FontSize="14" 
                                       TextColor="{DynamicResource TertiaryTextColor}" 
                                       HorizontalOptions="Center" 
                                       MaxLines="2" 
                                       LineBreakMode="WordWrap" 
                                       Margin="20,5,20,0" />
                            </VerticalStackLayout>
                        </Grid>
                    </CollectionView.EmptyView>

                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="models:ChatModel">
                            <Border Margin="15,5" 
                                    Padding="0"
                                    StrokeThickness="0"
                                    StrokeShape="RoundRectangle 15,15,15,15"
                                    BackgroundColor="{DynamicResource CardBackgroundColor}">
                                <Border.Shadow>
                                    <Shadow Brush="{DynamicResource ShadowColor}"
                                            Offset="0,2"
                                            Opacity="0.2"
                                            Radius="4" />
                                </Border.Shadow>

                                <Grid ColumnDefinitions="Auto,*,Auto" RowDefinitions="Auto,Auto,Auto" Padding="12">
                                    <!-- Profile Picture / Initials -->
                                    <Border Grid.Column="0" 
                                            Grid.RowSpan="3"
                                            StrokeThickness="0"
                                            HeightRequest="55" 
                                            WidthRequest="55" 
                                            StrokeShape="RoundRectangle 27.5,27.5,27.5,27.5"
                                            BackgroundColor="{DynamicResource PrimaryColor}"
                                            VerticalOptions="Center"
                                            HorizontalOptions="Center">
                                        <Label Text="{Binding OtherParticipant.Initials}" 
                                               TextColor="White" 
                                               FontSize="22" 
                                               FontAttributes="Bold" 
                                               VerticalOptions="Center" 
                                               HorizontalOptions="Center" />
                                        <!-- Gradient border -->
                                        <Border.Stroke>
                                            <LinearGradientBrush EndPoint="1,0">
                                                <GradientStop Color="{DynamicResource GradientStart}"
                                                              Offset="0.0" />
                                                <GradientStop Color="{DynamicResource GradientEnd}"
                                                              Offset="1.0" />
                                            </LinearGradientBrush>
                                        </Border.Stroke>
                                    </Border>

                                    <!-- Online indicator dot -->
                                    <Ellipse Grid.Column="0" 
         Grid.Row="0"
         IsVisible="{Binding OtherParticipant.IsOnline, Mode=OneWay}"
         Fill="{DynamicResource OnlineStatusColor}" 
         HeightRequest="12" 
         WidthRequest="12"
         Stroke="{DynamicResource CardBackgroundColor}"
         StrokeThickness="2"
         HorizontalOptions="End"
         VerticalOptions="Start" 
         Margin="0,0,2,0"
         ZIndex="1">
                                        <Ellipse.Shadow>
                                            <Shadow Brush="{DynamicResource OnlineStatusColor}"
                Offset="0,0"
                Opacity="0.5"
                Radius="5" />
                                        </Ellipse.Shadow>
                                    </Ellipse>

                                    <!-- Chat Name -->
                                    <Label Grid.Column="1" 
                                           Grid.Row="0" 
                                           Text="{Binding DisplayTitle}" 
                                           FontSize="16" 
                                           FontAttributes="Bold" 
                                           TextColor="{DynamicResource PrimaryTextColor}"
                                           Margin="15,0,0,0" />

                                    <!-- Online Status -->
                                    <Label Grid.Column="1" 
                                           Grid.Row="1" 
                                           Text="{Binding LastActivityStatus}" 
                                           FontSize="12" 
                                           TextColor="{DynamicResource TertiaryTextColor}" 
                                           Margin="15,0,0,0" />

                                    <!-- Last Message -->
                                    <Label Grid.Column="1" 
                                           Grid.Row="2" 
                                           Text="{Binding LastMessage}" 
                                           FontSize="14" 
                                           LineBreakMode="TailTruncation" 
                                           MaxLines="1" 
                                           TextColor="{DynamicResource SecondaryTextColor}" 
                                           Margin="15,5,0,0" />

                                    <!-- Time & Unread Count -->
                                    <VerticalStackLayout Grid.Column="2" Grid.RowSpan="3" VerticalOptions="Center" Spacing="5">
                                        <Label Text="{Binding LastMessageTimeFormatted}" 
                                               FontSize="12" 
                                               HorizontalOptions="End" 
                                               TextColor="{DynamicResource TertiaryTextColor}" />

                                        <Border IsVisible="{Binding UnreadCount, Converter={StaticResource StringToBoolConverter}}"
                                               BackgroundColor="{DynamicResource PrimaryColor}" 
                                               StrokeShape="RoundRectangle 12,12,12,12"
                                               HeightRequest="24" 
                                               MinimumWidthRequest="24" 
                                               Padding="5,0"
                                               HorizontalOptions="End"
                                               Margin="0,5,0,0">
                                            <Border.Shadow>
                                                <Shadow Brush="{DynamicResource PrimaryColor}"
                                                        Offset="0,0"
                                                        Opacity="0.4"
                                                        Radius="5" />
                                            </Border.Shadow>
                                            <Label Text="{Binding UnreadCount}" 
                                                   TextColor="White" 
                                                   FontSize="12" 
                                                   FontAttributes="Bold" 
                                                   HorizontalOptions="Center" 
                                                   VerticalOptions="Center" />
                                        </Border>
                                    </VerticalStackLayout>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>

                <!-- Loading Indicator -->
                <Border IsVisible="{Binding IsLoading}"
            HorizontalOptions="Center" 
            VerticalOptions="Center"
            StrokeThickness="0"
            StrokeShape="RoundRectangle 12,12,12,12"
            BackgroundColor="{DynamicResource CardBackgroundColor}"
            Padding="20">
                    <Border.Shadow>
                        <Shadow Brush="{DynamicResource ShadowColor}"
                    Offset="0,3"
                    Opacity="0.2"
                    Radius="10" />
                    </Border.Shadow>
                    <VerticalStackLayout Spacing="10">
                        <ActivityIndicator IsRunning="True" 
                              Color="{DynamicResource PrimaryColor}" 
                              HeightRequest="40" 
                              WidthRequest="40" />
                        <Label Text="Loading chats..." 
                  TextColor="{DynamicResource PrimaryTextColor}" 
                  FontSize="14" 
                  HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </Border>
            </Grid>
        </RefreshView>
    </Grid>
</ContentView>